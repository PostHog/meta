# RFC: Full SAML support

- **Created:** *2022-03-08*
- **Owner:** @paolodamico (and later @Twixes)
- **GitHub issues:** [#5647](https://github.com/PostHog/posthog/issues/5647)

> While commenting on this, please comment on specific lines if possible, to thread the discussion.

## Overview

Currently we support SAML only on self-hosted. More users have requested support for this feature on the Cloud version too. Further, the self-hosted version does not support multitenancy SAML. This RFC contains a technical proposal for how to implement full multitenant SAML support.

## Background

From the original SAML issue on GitHub,
> This is a compliance feature that a lot of large-scale organizations require for full widespread rollout. When working at a large org, having a centralized place for provisioning and managing users can make the onboarding/offboarding process smoother and help reduce security risks. There's a great [Slack thread](https://posthogusers.slack.com/archives/CT7HXDEG3/p1628859965082200) by a community member about the importance of SAML and [this study](https://www.onelogin.com/press-center/press-releases/97-percent-of-saas-vendors-backing-saml-based-single-sign-on) by OneLogin in which they find that up to 97% of SaaS support have support (or plans) for SAML. 


## Proposal

1. SAML configuration becomes organization-based instead of instance-based. We create a separate model for `OrganizationConfiguration` where we track all SAML parameters (ACS URL, Entity ID, X509 certificate and attribute names [4]).
2. Drop `SAML_ENFORCED` in favor of a `SSO_ENFORCEMENT` attribute that supports `saml`, `google-oauth2`, `github` & `gitlab` to solve [#7535](https://github.com/PostHog/posthog/issues/7535) too.
3. Drop `SAML_DISABLED` support to make maintenance easier and avoid having multiple build flows. Drawback is that the FOSS version which does not support SAML will still require the SAML dependencies.
4. If SAML is enabled for at least one organization in the instance, the login page shows only the email input at first. Upon entering an email, we do an API request like below. Where `enforced_sso` contains information on whether to enforce log in with a particular SSO provider (either SAML, Google, ...) or `null` if the user has no SSO enforced **or the user does not exist.**
    ```
    GET /api/users/pre-login
    {
        "email": "test@posthog.com"
    }

    Response:
    {
        "enforced_sso": "saml"
    }
    ```

    > ⚠️ Security concern. If the user has any SSO enforced, it could leak information about which users are registered in the PostHog instance.
5. If the user belongs to an organization with some form of SSO enforced, we won't allow logging in with password or changing password. If the user requests a password reset we'll only include the information about which SSO provider to use but no link to reset the password.
6. Bugs [#5759 Respect redirect URL when logging in with SAML](https://github.com/PostHog/posthog/issues/5759) & [#5839 Fix team member invites with SAML](https://github.com/PostHog/posthog/issues/5839) should be addressed too.
7. Generally, users with SSO enforced will likely only belong to a single organization (because it means you're likely using your work email). However, there's the edge case of a user belonging to multiple organizations with different SSO policies. Here's how we'll address them.
    - If the user attempts to join an organization that has a different SSO policy from the ones present in their current organization(s), we won't allow the user to join the new organization and show a warning explaining why.
    - When enabling SSO enforcement for an organization, we'll show a warning to the admin signalling any users who belong to multiple organizations and be very clear that the SSO requirement will not be enforced for them unless they leave their other organizations.
    - When checking SSO enforcement, we'll only enforce SSO with a provider if all the user's organizations have the same SSO enforcement policy. Otherwise, we'll allow any login mechanism (including password).


## Additional considerations
- On PostHog Cloud, automatic provisioning of users based on belonging to a single G-suite (or equivalent) directory will not be supported. Users will have to be explicitly invited to PostHog. We can later extend this functionality by making the domain whitelist work on PostHog Cloud.